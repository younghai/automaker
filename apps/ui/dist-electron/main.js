"use strict";const o=require("path"),C=require("child_process"),Te=require("crypto"),ge=require("http"),Ie=require("net"),a=require("electron");require("fs/promises");const g=require("fs");require("readline");const m=require("os"),Ce=require("util");var P;(function(e){e[e.ERROR=0]="ERROR",e[e.WARN=1]="WARN",e[e.INFO=2]="INFO",e[e.DEBUG=3]="DEBUG"})(P||(P={}));const ie={error:P.ERROR,warn:P.WARN,info:P.INFO,debug:P.DEBUG},y={reset:"\x1B[0m",red:"\x1B[31m",yellow:"\x1B[33m",blue:"\x1B[34m",magenta:"\x1B[35m",cyan:"\x1B[36m",gray:"\x1B[90m"},p={timestamp:"color: #6b7280; font-size: 11px;",context:"color: #3b82f6; font-weight: 600;",reset:"color: inherit; font-weight: inherit;",levels:{ERROR:"background: #ef4444; color: white; font-weight: bold; padding: 1px 6px; border-radius: 3px;",WARN:"background: #f59e0b; color: white; font-weight: bold; padding: 1px 6px; border-radius: 3px;",INFO:"background: #3b82f6; color: white; font-weight: bold; padding: 1px 6px; border-radius: 3px;",DEBUG:"background: #8b5cf6; color: white; font-weight: bold; padding: 1px 6px; border-radius: 3px;"}},X=typeof globalThis.window<"u";let b=P.INFO;function Q(e){if(!X)try{return process.env?.[e]}catch{return}}let z=!X&&Q("LOG_COLORS")!=="false",Me=Q("LOG_TIMESTAMPS")==="true";const V=Q("LOG_LEVEL")?.toLowerCase();V&&ie[V]!==void 0&&(b=ie[V]);function se(){return new Date().toISOString()}function F(){return new Date().toISOString().split("T")[1].slice(0,12)}function L(e,n,t){const i=[];Me&&i.push(z?`${y.gray}${se()}${y.reset}`:se());const r=e.padEnd(5);return i.push(z?`${t}${r}${y.reset}`:r),i.push(z?`${y.blue}[${n}]${y.reset}`:`[${n}]`),i.join(" ")}function we(e){if(X)return{error:(...t)=>{b>=P.ERROR&&console.error(`%cERROR%c %c${F()}%c %c[${e}]%c`,p.levels.ERROR,p.reset,p.timestamp,p.reset,p.context,p.reset,...t)},warn:(...t)=>{b>=P.WARN&&console.warn(`%cWARN%c %c${F()}%c %c[${e}]%c`,p.levels.WARN,p.reset,p.timestamp,p.reset,p.context,p.reset,...t)},info:(...t)=>{b>=P.INFO&&console.log(`%cINFO%c %c${F()}%c %c[${e}]%c`,p.levels.INFO,p.reset,p.timestamp,p.reset,p.context,p.reset,...t)},debug:(...t)=>{b>=P.DEBUG&&console.log(`%cDEBUG%c %c${F()}%c %c[${e}]%c`,p.levels.DEBUG,p.reset,p.timestamp,p.reset,p.context,p.reset,...t)}};function n(t,...i){try{console[t](...i)}catch(r){if(r?.code!=="EPIPE")throw r}}return{error:(...t)=>{b>=P.ERROR&&n("error",L("ERROR",e,y.red),...t)},warn:(...t)=>{b>=P.WARN&&n("log",L("WARN",e,y.yellow),...t)},info:(...t)=>{b>=P.INFO&&n("log",L("INFO",e,y.cyan),...t)},debug:(...t)=>{b>=P.DEBUG&&n("log",L("DEBUG",e,y.magenta),...t)}}}class Fe{value;next;constructor(n){this.value=n}}class Le{#e;#n;#o;constructor(){this.clear()}enqueue(n){const t=new Fe(n);this.#e?(this.#n.next=t,this.#n=t):(this.#e=t,this.#n=t),this.#o++}dequeue(){const n=this.#e;if(n)return this.#e=this.#e.next,this.#o--,this.#e||(this.#n=void 0),n.value}peek(){if(this.#e)return this.#e.value}clear(){this.#e=void 0,this.#n=void 0,this.#o=0}get size(){return this.#o}*[Symbol.iterator](){let n=this.#e;for(;n;)yield n.value,n=n.next}*drain(){for(;this.#e;)yield this.dequeue()}}function ke(e){ae(e);const n=new Le;let t=0;const i=()=>{t<e&&n.size>0&&(n.dequeue()(),t++)},r=()=>{t--,i()},s=async(u,h,v)=>{const M=(async()=>u(...v))();h(M);try{await M}catch{}r()},l=(u,h,v)=>{new Promise(M=>{n.enqueue(M)}).then(s.bind(void 0,u,h,v)),(async()=>(await Promise.resolve(),t<e&&i()))()},f=(u,...h)=>new Promise(v=>{l(u,v,h)});return Object.defineProperties(f,{activeCount:{get:()=>t},pendingCount:{get:()=>n.size},clearQueue:{value(){n.clear()}},concurrency:{get:()=>e,set(u){ae(u),e=u,queueMicrotask(()=>{for(;t<e&&n.size>0;)i()})}}}),f}function ae(e){if(!((Number.isInteger(e)||e===Number.POSITIVE_INFINITY)&&e>0))throw new TypeError("Expected `concurrency` to be a number from 1 and up")}let O=null,$=null;function We(){const e=process.env.ALLOWED_ROOT_DIRECTORY;e?(O=o.resolve(e),console.log(`[Security] ✓ ALLOWED_ROOT_DIRECTORY configured: ${O}`)):console.log("[Security] ⚠️  ALLOWED_ROOT_DIRECTORY not set - allowing access to all paths");const n=process.env.DATA_DIR;n&&($=o.resolve(n),console.log(`[Security] ✓ DATA_DIR configured: ${$}`))}function $e(e){const n=o.resolve(e);return!!($&&ce(n,$)||!O||O&&ce(n,O))}function ce(e,n){const t=o.relative(n,e);return!t.startsWith("..")&&!o.isAbsolute(t)}function Be(){return O}const Ge={maxConcurrency:100,maxRetries:3,baseDelay:100,maxDelay:5e3};let Ue={...Ge};ke(Ue.maxConcurrency);function ze(){return process.platform==="win32"?[o.join(process.env.LOCALAPPDATA||"","Programs","gh","bin","gh.exe"),o.join(process.env.ProgramFiles||"","GitHub CLI","gh.exe")].filter(Boolean):["/opt/homebrew/bin/gh","/usr/local/bin/gh",o.join(m.homedir(),".local","bin","gh"),"/home/linuxbrew/.linuxbrew/bin/gh"]}function Ve(){if(process.platform==="win32"){const n=process.env.APPDATA||o.join(m.homedir(),"AppData","Roaming");return[o.join(m.homedir(),".local","bin","claude.exe"),o.join(n,"npm","claude.cmd"),o.join(n,"npm","claude"),o.join(n,".npm-global","bin","claude.cmd"),o.join(n,".npm-global","bin","claude")]}return[o.join(m.homedir(),".local","bin","claude"),o.join(m.homedir(),".claude","local","claude"),"/usr/local/bin/claude",o.join(m.homedir(),".npm-global","bin","claude")]}function Pe(){const e=process.env.NVM_DIR||o.join(m.homedir(),".nvm"),n=o.join(e,"versions","node");try{return g.existsSync(n)?g.readdirSync(n).map(i=>o.join(n,i,"bin")):[]}catch{return[]}}function ve(){const e=m.homedir(),n=[o.join(e,".local","share","fnm","node-versions"),o.join(e,".fnm","node-versions"),o.join(e,"Library","Application Support","fnm","node-versions")],t=[];for(const i of n)try{if(!g.existsSync(i))continue;const r=g.readdirSync(i);for(const s of r)t.push(o.join(i,s,"installation","bin"))}catch{}return t}function qe(){const e=process.platform==="win32",n=m.homedir();if(e){const s=process.env.APPDATA||o.join(n,"AppData","Roaming"),l=process.env.LOCALAPPDATA||o.join(n,"AppData","Local");return[o.join(n,".local","bin","codex.exe"),o.join(s,"npm","codex.cmd"),o.join(s,"npm","codex"),o.join(s,".npm-global","bin","codex.cmd"),o.join(s,".npm-global","bin","codex"),o.join(n,".volta","bin","codex.exe"),o.join(l,"pnpm","codex.cmd"),o.join(l,"pnpm","codex")]}const t=Pe().map(s=>o.join(s,"codex")),i=ve().map(s=>o.join(s,"codex")),r=process.env.PNPM_HOME||o.join(n,".local","share","pnpm");return[o.join(n,".local","bin","codex"),"/opt/homebrew/bin/codex","/usr/local/bin/codex","/usr/bin/codex",o.join(n,".npm-global","bin","codex"),"/home/linuxbrew/.linuxbrew/bin/codex",o.join(n,".volta","bin","codex"),o.join(r,"codex"),o.join(n,".yarn","bin","codex"),o.join(n,".config","yarn","global","node_modules",".bin","codex"),"/snap/bin/codex",...t,...i]}const He=".codex",Ye="auth.json";function J(){return o.join(m.homedir(),He)}function Ke(){return o.join(J(),Ye)}function T(){return o.join(m.homedir(),".claude")}function Xe(){const e=T();return[o.join(e,".credentials.json"),o.join(e,"credentials.json")]}function Qe(){return o.join(T(),"settings.json")}function Je(){return o.join(T(),"stats-cache.json")}function be(){return o.join(T(),"projects")}function le(e,n,...t){try{return g.existsSync(e)?g.readdirSync(e).filter(s=>s.startsWith(n)).map(s=>o.join(e,s,...t)):[]}catch{return[]}}function Ze(){if(process.platform!=="win32")return[];const e=m.homedir(),n=process.env.LOCALAPPDATA||"",t=n?le(o.join(n,"Microsoft","WinGet","Packages"),"Git.Git_","bin","bash.exe"):[],i=n?le(o.join(n,"GitHubDesktop"),"app-","resources","app","git","cmd","bash.exe"):[];return["C:\\Program Files\\Git\\bin\\bash.exe","C:\\Program Files (x86)\\Git\\bin\\bash.exe",o.join(n,"Programs","Git","bin","bash.exe"),o.join(e,"scoop","apps","git","current","bin","bash.exe"),o.join(process.env.ChocolateyInstall||"C:\\ProgramData\\chocolatey","lib","git","tools","bin","bash.exe"),...t,...i].filter(Boolean)}function en(){return process.platform==="win32"?["C:\\Program Files\\PowerShell\\7\\pwsh.exe","C:\\Program Files\\PowerShell\\7-preview\\pwsh.exe","C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe",process.env.COMSPEC||"C:\\Windows\\System32\\cmd.exe","pwsh.exe","pwsh","powershell.exe","powershell","cmd.exe","cmd"]:["/bin/zsh","/bin/bash","/bin/sh","/usr/bin/zsh","/usr/bin/bash","/usr/bin/sh","/usr/local/bin/zsh","/usr/local/bin/bash","/opt/homebrew/bin/zsh","/opt/homebrew/bin/bash","zsh","bash","sh"]}function B(){const e=m.homedir();if(process.platform==="win32"){const n=process.env.APPDATA||o.join(e,"AppData","Roaming");return[o.join(n,"nvm")]}return[o.join(e,".nvm","versions","node")]}function G(){const e=m.homedir();if(process.platform==="win32"){const n=process.env.LOCALAPPDATA||o.join(e,"AppData","Local");return[o.join(e,".fnm","node-versions"),o.join(n,"fnm","node-versions")]}return process.platform==="darwin"?[o.join(e,".local","share","fnm","node-versions"),o.join(e,"Library","Application Support","fnm","node-versions")]:[o.join(e,".local","share","fnm","node-versions"),o.join(e,".fnm","node-versions")]}function U(){return process.platform==="win32"?[o.join(process.env.PROGRAMFILES||"C:\\Program Files","nodejs","node.exe"),o.join(process.env["PROGRAMFILES(X86)"]||"C:\\Program Files (x86)","nodejs","node.exe")]:process.platform==="darwin"?["/opt/homebrew/bin/node","/usr/local/bin/node","/usr/bin/node"]:["/usr/bin/node","/usr/local/bin/node","/snap/bin/node"]}function ye(){return o.join(m.homedir(),"scoop","apps","nodejs","current","node.exe")}function xe(){return o.join(process.env.ChocolateyInstall||"C:\\ProgramData\\chocolatey","bin","node.exe")}function nn(){return"/proc/version"}function Ee(e){if(!Z(e))throw new Error(`[SystemPaths] Access denied: ${e} is not an allowed system path`);return g.existsSync(e)}function on(e){if(!Z(e))throw new Error(`[SystemPaths] Access denied: ${e} is not an allowed system path`);try{return process.platform==="win32"?g.accessSync(e,g.constants.F_OK):g.accessSync(e,g.constants.X_OK),!0}catch{return!1}}function tn(e){if(!Z(e))throw new Error(`[SystemPaths] Access denied: ${e} is not an allowed system path`);return g.readdirSync(e)}function rn(){return[...ze(),...Ve(),T(),...Xe(),Qe(),Je(),be(),...qe(),J(),Ke(),...pn(),ne(),hn(),...en(),...Ze(),...U(),ye(),xe(),nn()]}function sn(){return[T(),be(),J(),ne(),...B(),...G()]}function Z(e){const n=o.resolve(e);if(rn().includes(n))return!0;const i=sn();for(const r of i){const s=o.resolve(r);if(n===s||n.startsWith(s+o.sep))return!0}return!1}let S=null;function an(e){S=e}function je(e,n="utf-8"){if(!S)throw new Error("[SystemPaths] Electron userData path not initialized");const t=o.join(S,e);return g.readFileSync(t,n)}function Ae(e,n,t){if(!S)throw new Error("[SystemPaths] Electron userData path not initialized");const i=o.join(S,e);g.writeFileSync(i,n,t)}function De(e){if(!S)return!1;const n=o.join(S,e);return g.existsSync(n)}let _e=[],Y=null;function de(e,n){_e=Array.isArray(e)?e:[e],Y=n||null}function ee(e){const n=o.resolve(e);for(const t of _e){const i=o.resolve(t);if(n===i||n.startsWith(i+o.sep))return!0}if(Y){const t=o.resolve(Y);if(n===t||n.startsWith(t+o.sep))return!0}return!1}function A(e){if(!ee(e))throw new Error(`[SystemPaths] Access denied: ${e} is not within Electron app bundle`);return g.existsSync(e)}function cn(e,n){if(!ee(e)){n(new Error(`[SystemPaths] Access denied: ${e} is not within Electron app bundle`),void 0);return}g.stat(e,n)}function ln(e,n){if(!ee(e)){n(new Error(`[SystemPaths] Access denied: ${e} is not within Electron app bundle`),void 0);return}g.readFile(e,n)}const dn=".local/share/opencode",un="auth.json";function pn(){const e=process.platform==="win32",n=m.homedir();if(e){const s=process.env.APPDATA||o.join(n,"AppData","Roaming"),l=process.env.LOCALAPPDATA||o.join(n,"AppData","Local");return[o.join(n,".opencode","bin","opencode.exe"),o.join(n,".local","bin","opencode.exe"),o.join(s,"npm","opencode.cmd"),o.join(s,"npm","opencode"),o.join(s,".npm-global","bin","opencode.cmd"),o.join(s,".npm-global","bin","opencode"),o.join(n,".volta","bin","opencode.exe"),o.join(l,"pnpm","opencode.cmd"),o.join(l,"pnpm","opencode"),o.join(n,"go","bin","opencode.exe"),o.join(process.env.GOPATH||o.join(n,"go"),"bin","opencode.exe")]}const t=Pe().map(s=>o.join(s,"opencode")),i=ve().map(s=>o.join(s,"opencode")),r=process.env.PNPM_HOME||o.join(n,".local","share","pnpm");return[o.join(n,".opencode","bin","opencode"),o.join(n,".local","bin","opencode"),"/opt/homebrew/bin/opencode","/usr/local/bin/opencode","/usr/bin/opencode",o.join(n,".npm-global","bin","opencode"),"/home/linuxbrew/.linuxbrew/bin/opencode",o.join(n,".volta","bin","opencode"),o.join(r,"opencode"),o.join(n,".yarn","bin","opencode"),o.join(n,".config","yarn","global","node_modules",".bin","opencode"),o.join(n,"go","bin","opencode"),o.join(process.env.GOPATH||o.join(n,"go"),"bin","opencode"),"/snap/bin/opencode",...t,...i]}function ne(){return o.join(m.homedir(),dn)}function hn(){return o.join(ne(),un)}const fn=/^v?\d+/,ue=/-(beta|rc|alpha|nightly|canary|dev|pre)/i;function D(e){try{return on(e)}catch{return!1}}function N(e,n="bin/node"){try{if(!Ee(e))return null}catch{return null}try{const t=tn(e).filter(s=>fn.test(s)).sort((s,l)=>l.localeCompare(s,void 0,{numeric:!0,sensitivity:"base"})),i=t.filter(s=>!ue.test(s)),r=t.filter(s=>ue.test(s));for(const s of[...i,...r]){const l=o.join(e,s,n);if(D(l))return l}}catch{}return null}function mn(e){const n=U();for(const r of n)if(D(r))return r.includes("homebrew")||r==="/usr/local/bin/node"?{nodePath:r,source:"homebrew"}:{nodePath:r,source:"system"};const t=B();for(const r of t){const s=N(r);if(s)return{nodePath:s,source:"nvm"}}const i=G();for(const r of i){const s=N(r);if(s)return{nodePath:s,source:"fnm"}}return null}function gn(e){const n=U();for(const r of n)if(D(r))return{nodePath:r,source:"system"};const t=B();for(const r of t){const s=N(r);if(s)return{nodePath:s,source:"nvm"}}const i=G();for(const r of i){const s=N(r);if(s)return{nodePath:s,source:"fnm"}}return null}function wn(e){const n=U();for(const l of n)if(D(l))return{nodePath:l,source:"program-files"};const t=B();for(const l of t){const f=N(l,"node.exe");if(f)return{nodePath:f,source:"nvm-windows"}}const i=G();for(const l of i){const f=N(l,"node.exe");if(f)return{nodePath:f,source:"fnm"}}const r=ye();if(D(r))return{nodePath:r,source:"scoop"};const s=xe();return D(s)?{nodePath:s,source:"chocolatey"}:null}function Pn(e,n=()=>{}){try{const t=e==="win32"?"where node":"which node",r=C.execSync(t,{encoding:"utf8",stdio:["pipe","pipe","pipe"]}).trim().split(/\r?\n/)[0];if(r&&!r.includes("\0")&&D(r))return{nodePath:r,source:e==="win32"?"where":"which"}}catch{n("Shell command failed to find Node.js (expected when launched from desktop)")}return null}function vn(e={}){const{skipSearch:n=!1,logger:t=()=>{}}=e;if(n)return{nodePath:"node",source:"fallback"};const i=process.platform;m.homedir();let r=null;switch(i){case"darwin":r=mn();break;case"linux":r=gn();break;case"win32":r=wn();break}return r?(t(`Found Node.js via ${r.source} at: ${r.nodePath}`),r):(r=Pn(i,t),r?(t(`Found Node.js via ${r.source} at: ${r.nodePath}`),r):(t('Could not find Node.js, falling back to "node"'),{nodePath:"node",source:"fallback"}))}function bn(e,n=""){if(e==="node")return n;const t=o.dirname(e),i=o.normalize(t),r=n.split(o.delimiter).map(s=>o.normalize(s));return i==="."||r.includes(i)?n:n?`${t}${o.delimiter}${n}`:t}const Se=[{id:"opencode/big-pickle",label:"Big Pickle",description:"OpenCode free tier model - great for general coding",supportsVision:!1,provider:"opencode",tier:"free"},{id:"opencode/glm-4.7-free",label:"GLM 4.7 Free",description:"OpenCode free tier GLM model",supportsVision:!1,provider:"opencode",tier:"free"},{id:"opencode/gpt-5-nano",label:"GPT-5 Nano",description:"OpenCode free tier nano model - fast and lightweight",supportsVision:!1,provider:"opencode",tier:"free"},{id:"opencode/grok-code",label:"Grok Code",description:"OpenCode free tier Grok model for coding",supportsVision:!1,provider:"opencode",tier:"free"},{id:"opencode/minimax-m2.1-free",label:"MiniMax M2.1 Free",description:"OpenCode free tier MiniMax model",supportsVision:!1,provider:"opencode",tier:"free"}];Se.reduce((e,n)=>(e[n.id]=n,e),{});function yn(){return Se.map(e=>e.id)}yn();Ce.promisify(C.execFile);process.platform;process.platform;const xn=["antigravity","agy"],[Nn,...Tn]=xn,c=we("Electron"),k=we("Server"),R=!a.app.isPackaged,pe=process.env.VITE_DEV_SERVER_URL;if(R)try{require("dotenv").config({path:o.join(__dirname,"../.env")})}catch(e){c.warn("dotenv not available:",e.message)}let d=null,w=null,E=null;const I=parseInt(process.env.PORT||"3008",10),W=parseInt(process.env.TEST_PORT||"3007",10);let x=I,_=W;function En(e){return new Promise(n=>{const t=Ie.createServer();t.once("error",()=>{n(!1)}),t.once("listening",()=>{t.close(()=>{n(!0)})}),t.listen(e)})}async function he(e){for(let n=0;n<100;n++){const t=e+n;if(await En(t))return t}throw new Error(`Could not find an available port starting from ${e}`)}const oe=600,te=500,jn=1600,An=950;let q=null,j=null,re=!1;const H=".api-key";function Dn(){try{if(De(H)){const e=je(H).trim();if(e)return j=e,c.info("Loaded existing API key"),j}}catch(e){c.warn("Error reading API key:",e)}j=Te.randomUUID();try{Ae(H,j,{encoding:"utf-8",mode:384}),c.info("Generated new API key")}catch(e){c.error("Failed to save API key:",e)}return j}function Re(){let e;process.platform==="win32"?e="icon.ico":(process.platform,e="logo_larger.png");const n=R?o.join(__dirname,"../public",e):o.join(__dirname,"../dist/public",e);try{if(!A(n))return c.warn("Icon not found at:",n),null}catch(t){return c.warn("Icon check failed:",n,t),null}return n}const K="window-bounds.json";function _n(){try{if(De(K)){const e=je(K),n=JSON.parse(e);if(typeof n.x=="number"&&typeof n.y=="number"&&typeof n.width=="number"&&typeof n.height=="number")return n}}catch(e){c.warn("Failed to load window bounds:",e.message)}return null}function Oe(e){try{Ae(K,JSON.stringify(e,null,2)),c.info("Window bounds saved")}catch(n){c.warn("Failed to save window bounds:",n.message)}}function fe(){!d||d.isDestroyed()||(q&&clearTimeout(q),q=setTimeout(()=>{if(!d||d.isDestroyed())return;const e=d.isMaximized(),n=e?d.getNormalBounds():d.getBounds();Oe({x:n.x,y:n.y,width:n.width,height:n.height,isMaximized:e})},500))}function Sn(e){const n=a.screen.getAllDisplays(),t=e.x+e.width/2,i=e.y+e.height/2;let r=!1;for(const s of n){const{x:l,y:f,width:u,height:h}=s.workArea;if(t>=l&&t<=l+u&&i>=f&&i<=f+h){r=!0;break}}if(!r){const s=a.screen.getPrimaryDisplay(),{x:l,y:f,width:u,height:h}=s.workArea;return{x:l+Math.floor((u-e.width)/2),y:f+Math.floor((h-e.height)/2),width:Math.min(e.width,u),height:Math.min(e.height,h),isMaximized:e.isMaximized}}return{...e,width:Math.max(e.width,oe),height:Math.max(e.height,te)}}async function Rn(){const e=o.join(__dirname,"../dist");return E=ge.createServer((n,t)=>{let i=o.join(e,n.url?.split("?")[0]||"/");if(i.endsWith("/"))i=o.join(i,"index.html");else if(!o.extname(i)){const r=i+".html";try{!A(i)&&!A(r)?i=o.join(e,"index.html"):A(r)&&(i=r)}catch{i=o.join(e,"index.html")}}cn(i,(r,s)=>{(r||!s?.isFile())&&(i=o.join(e,"index.html")),ln(i,(l,f)=>{if(l||!f){t.writeHead(500),t.end("Server Error");return}const u=o.extname(i),h={".html":"text/html",".js":"application/javascript",".css":"text/css",".json":"application/json",".png":"image/png",".jpg":"image/jpeg",".gif":"image/gif",".svg":"image/svg+xml",".ico":"image/x-icon",".woff":"font/woff",".woff2":"font/woff2",".ttf":"font/ttf",".eot":"application/vnd.ms-fontobject"};t.writeHead(200,{"Content-Type":h[u]||"application/octet-stream"}),t.end(f)})})}),new Promise((n,t)=>{E.listen(_,()=>{c.info("Static server running at http://localhost:"+_),n()}),E.on("error",t)})}async function On(){const e=vn({skipSearch:R,logger:u=>c.info(u)}),n=e.nodePath;if(n!=="node"){let u;try{u=Ee(n)}catch(h){const v=h instanceof Error?h.message:String(h);throw new Error(`Failed to verify Node.js executable at: ${n} (source: ${e.source}). Reason: ${v}`)}if(!u)throw new Error(`Node.js executable not found at: ${n} (source: ${e.source})`)}let t,i;if(R){i=o.join(__dirname,"../../server/src/index.ts");const u=o.join(__dirname,"../../server/node_modules/tsx"),h=o.join(__dirname,"../../../node_modules/tsx");let v;try{if(A(o.join(u,"dist/cli.mjs")))v=o.join(u,"dist/cli.mjs");else if(A(o.join(h,"dist/cli.mjs")))v=o.join(h,"dist/cli.mjs");else try{v=require.resolve("tsx/cli.mjs",{paths:[o.join(__dirname,"../../server")]})}catch{throw new Error("Could not find tsx. Please run 'npm install' in the server directory.")}}catch{try{v=require.resolve("tsx/cli.mjs",{paths:[o.join(__dirname,"../../server")]})}catch{throw new Error("Could not find tsx. Please run 'npm install' in the server directory.")}}t=[v,"watch",i]}else{i=o.join(process.resourcesPath,"server","index.js"),t=[i];try{if(!A(i))throw new Error(`Server not found at: ${i}`)}catch{throw new Error(`Server not found at: ${i}`)}}const r=a.app.isPackaged?o.join(process.resourcesPath,"server","node_modules"):o.join(__dirname,"../../server/node_modules"),s=a.app.isPackaged?o.join(process.resourcesPath,"server"):o.join(__dirname,"../../server"),l=bn(n,process.env.PATH||"");l!==process.env.PATH&&c.info("Enhanced PATH with Node directory:",o.dirname(n));const f={...process.env,PATH:l,PORT:x.toString(),DATA_DIR:a.app.getPath("userData"),NODE_PATH:r,AUTOMAKER_API_KEY:j,...process.env.ALLOWED_ROOT_DIRECTORY&&{ALLOWED_ROOT_DIRECTORY:process.env.ALLOWED_ROOT_DIRECTORY}};c.info("Server will use port",x),c.info("Starting backend server..."),c.info("Server path:",i),c.info("Server root (cwd):",s),c.info("NODE_PATH:",r),w=C.spawn(n,t,{cwd:s,env:f,stdio:["ignore","pipe","pipe"]}),w.stdout?.on("data",u=>{k.info(u.toString().trim())}),w.stderr?.on("data",u=>{k.error(u.toString().trim())}),w.on("close",u=>{k.info("Process exited with code",u),w=null}),w.on("error",u=>{k.error("Failed to start server process:",u),w=null}),await Ne()}async function Ne(e=30){for(let n=0;n<e;n++)try{await new Promise((t,i)=>{const r=ge.get(`http://localhost:${x}/api/health`,s=>{s.statusCode===200?t():i(new Error(`Status: ${s.statusCode}`))});r.on("error",i),r.setTimeout(1e3,()=>{r.destroy(),i(new Error("Timeout"))})}),c.info("Server is ready");return}catch{await new Promise(t=>setTimeout(t,500))}throw new Error("Server failed to start")}function me(){const e=Re(),n=_n(),t=n?Sn(n):null,i={width:t?.width??jn,height:t?.height??An,x:t?.x,y:t?.y,minWidth:oe,minHeight:te,webPreferences:{preload:o.join(__dirname,"preload.js"),contextIsolation:!0,nodeIntegration:!1},titleBarStyle:"hiddenInset",backgroundColor:"#0a0a0a"};e&&(i.icon=e),d=new a.BrowserWindow(i),t?.isMaximized&&d.maximize(),pe?d.loadURL(pe):R?d.loadURL(`http://localhost:${_}`):d.loadURL(`http://localhost:${_}`),R&&process.env.OPEN_DEVTOOLS==="true"&&d.webContents.openDevTools(),d.on("close",()=>{if(d&&!d.isDestroyed()){const r=d.isMaximized(),s=r?d.getNormalBounds():d.getBounds();Oe({x:s.x,y:s.y,width:s.width,height:s.height,isMaximized:r})}}),d.on("closed",()=>{d=null}),d.on("resized",()=>{fe()}),d.on("moved",()=>{fe()}),d.webContents.setWindowOpenHandler(({url:r})=>(a.shell.openExternal(r),{action:"deny"}))}a.app.whenReady().then(async()=>{try{const e=o.join(a.app.getPath("appData"),"Automaker");a.app.getPath("userData")!==e&&(a.app.setPath("userData",e),c.info("userData path set to:",e))}catch(e){c.warn("Failed to set userData path:",e.message)}if(an(a.app.getPath("userData")),R){const e=o.join(__dirname,"../../..");de([__dirname,e])}else de(__dirname,process.resourcesPath);if(c.info("Initialized path security helpers"),process.env.DATA_DIR=a.app.getPath("userData"),We(),process.platform==="darwin"&&a.app.dock){const e=Re();if(e)try{a.app.dock.setIcon(e)}catch(n){c.warn("Failed to set dock icon:",n.message)}}try{const e=process.env.SKIP_EMBEDDED_SERVER==="true";re=e,e?(x=I,c.info("SKIP_EMBEDDED_SERVER=true, using external server at port",x),c.info("Waiting for external server..."),await Ne(60),c.info("External server is ready"),c.info("External server mode: using session-based authentication")):(Dn(),x=await he(I),x!==I&&c.info("Default server port",I,"in use, using port",x)),_=await he(W),_!==W&&c.info("Default static port",W,"in use, using port",_),a.app.isPackaged&&await Rn(),e||await On(),me()}catch(e){c.error("Failed to start:",e);const n=e.message,t=n.includes("Node.js");a.dialog.showErrorBox("Automaker Failed to Start",`The application failed to start.

${n}

${t?"Please install Node.js from https://nodejs.org or via a package manager (Homebrew, nvm, fnm).":"Please check the application logs for more details."}`),a.app.quit()}a.app.on("activate",()=>{a.BrowserWindow.getAllWindows().length===0&&me()})});a.app.on("window-all-closed",()=>{if(process.platform!=="darwin"){if(w&&w.pid){if(c.info("All windows closed, stopping server..."),process.platform==="win32")try{C.execSync(`taskkill /f /t /pid ${w.pid}`,{stdio:"ignore"})}catch(e){c.error("Failed to kill server process:",e.message)}else w.kill("SIGTERM");w=null}E&&(c.info("Stopping static server..."),E.close(),E=null),a.app.quit()}});a.app.on("before-quit",()=>{if(w&&w.pid){if(c.info("Stopping server..."),process.platform==="win32")try{C.execSync(`taskkill /f /t /pid ${w.pid}`,{stdio:"ignore"})}catch(e){c.error("Failed to kill server process:",e.message)}else w.kill("SIGTERM");w=null}E&&(c.info("Stopping static server..."),E.close(),E=null)});a.ipcMain.handle("dialog:openDirectory",async()=>{if(!d)return{canceled:!0,filePaths:[]};const e=await a.dialog.showOpenDialog(d,{properties:["openDirectory","createDirectory"]});if(!e.canceled&&e.filePaths.length>0){const n=e.filePaths[0];if(!$e(n)){const t=Be(),i=t?`The selected directory is not allowed. Please select a directory within: ${t}`:"The selected directory is not allowed.";return await a.dialog.showErrorBox("Directory Not Allowed",i),{canceled:!0,filePaths:[]}}}return e});a.ipcMain.handle("dialog:openFile",async(e,n={})=>d?await a.dialog.showOpenDialog(d,{properties:["openFile"],...n}):{canceled:!0,filePaths:[]});a.ipcMain.handle("dialog:saveFile",async(e,n={})=>d?await a.dialog.showSaveDialog(d,n):{canceled:!0,filePath:void 0});a.ipcMain.handle("shell:openExternal",async(e,n)=>{try{return await a.shell.openExternal(n),{success:!0}}catch(t){return{success:!1,error:t.message}}});a.ipcMain.handle("shell:openPath",async(e,n)=>{try{return await a.shell.openPath(n),{success:!0}}catch(t){return{success:!1,error:t.message}}});a.ipcMain.handle("shell:openInEditor",async(e,n,t,i)=>{try{const r=n.replace(/\\/g,"/");let l=`vscode://file${r.startsWith("/")?"/"+r.slice(1).split("/").map(encodeURIComponent).join("/"):r.split("/").map(encodeURIComponent).join("/")}`;return t!==void 0&&t>0&&(l+=`:${t}`,i!==void 0&&i>0&&(l+=`:${i}`)),await a.shell.openExternal(l),{success:!0}}catch(r){return{success:!1,error:r.message}}});a.ipcMain.handle("app:getPath",async(e,n)=>a.app.getPath(n));a.ipcMain.handle("app:getVersion",async()=>a.app.getVersion());a.ipcMain.handle("app:isPackaged",async()=>a.app.isPackaged);a.ipcMain.handle("ping",async()=>"pong");a.ipcMain.handle("server:getUrl",async()=>`http://localhost:${x}`);a.ipcMain.handle("auth:getApiKey",()=>re?null:j);a.ipcMain.handle("auth:isExternalServerMode",()=>re);a.ipcMain.handle("window:updateMinWidth",(e,n)=>{!d||d.isDestroyed()||d.setMinimumSize(oe,te)});a.ipcMain.handle("app:quit",()=>{c.info("Quitting application via IPC request"),a.app.quit()});
